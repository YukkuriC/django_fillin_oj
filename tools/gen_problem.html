<html>

<head>
    <title>PyFillin出题机</title>
    <!-- bootstrap -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>

    <!-- codemirror -->

    <!-- codemirror base -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/codemirror/5.44.0/codemirror.min.css" />
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/codemirror.min.js"></script>

    <!-- codemirror python -->
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/mode/python/python.min.js"></script>

    <!-- 代码折叠 -->
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/fold/indent-fold.js"></script>
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/fold/foldcode.min.js"></script>
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/fold/foldgutter.min.js"></script>
    <link href="https://cdn.bootcss.com/codemirror/5.44.0/addon/fold/foldgutter.min.css" rel="stylesheet">

    <!-- 括号 -->
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/edit/matchbrackets.min.js"></script>

    <!-- sublime快捷键 -->
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/addon/comment/comment.min.js"></script>
    <script src="https://cdn.bootcss.com/codemirror/5.44.0/keymap/sublime.min.js"></script>

    <style>
        .CodeMirror {
            height: auto;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.5);
            line-height: 1em;
            font-size: 1em;
            font-family: "Consolas", 'Courier New', Courier, monospace
        }

        .CodeMirror-scroll {
            overflow-y: hidden;
            overflow-x: auto;
        }

        textarea {
            width: 100%;
            height: 40em
        }

        .smooth {
            transition: 0.3s all;
            overflow: hidden
        }

        .module {
            padding: 5px 0px;
        }

        .module:hover>.toolbar {
            max-height: 30px;
            opacity: 1;
        }

        .toolbar {
            font-size: 0.5em;
            opacity: 0;
            max-height: 0px;
            transition: 0.3s all;
        }

        #json_output {
            overflow-y: auto;
            white-space: pre-wrap;
            max-height: 40em;
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>

</head>

<body style='background: #eee'>
    <div class='container' style='background: white'>
        <br>
        <div class='row'>
            <div class="col-sm-2 dropdown">
                <a href="#" class="btn btn-secondary form-control dropdown-toggle" data-toggle="dropdown">插入</a>
                <ul class="dropdown-menu">
                    <li>
                        <button id='add_struct' class='btn form-control'>插入给定代码块</button>
                    </li>
                    <!-- <li>
                        <button id='add_fillin' class='btn form-control'>插入填空块</button>
                    </li> -->
                </ul>
            </div>
            <div class="col-sm-2 dropdown">
                <a href="#" class="btn btn-secondary form-control dropdown-toggle" data-toggle="dropdown">转换</a>
                <ul class="dropdown-menu">
                    <li>
                        <button id='module_to_json' class='btn form-control'>模块输出为JSON</button>
                    </li>
                    <li>
                        <button id='json_to_module' class='btn form-control'>JSON读取为模块</button>
                    </li>
                </ul>
            </div>
            <div class="col-sm-2 dropdown">
                <a href="#" class="btn btn-secondary form-control dropdown-toggle" data-toggle="dropdown">文件</a>
                <ul class="dropdown-menu">
                    <li>
                        <button id='load_code' class='btn form-control'>读取</button>
                    </li>
                    <li>
                        <button id='save_code' class='btn form-control'>保存</button>
                    </li>
                </ul>
            </div>
            <!-- <div class="col-sm-2 dropdown">
                <a href="#" class="btn btn-secondary form-control dropdown-toggle" data-toggle="dropdown">设置</a>
                <ul class="dropdown-menu">
                    <li>
                        <button id='codemirror_linewrap' class='btn form-control'>自动换行: 开</button>
                    </li>
                </ul>
            </div> -->
        </div>
        <br>
        <div class='row' id='fold_panels'>
            <div class='col-sm-6 smooth'>
                <h3>代码区域</h3>
                <div id="module_pool"></div>
            </div>
            <div class='col-sm-6 smooth'>
                <h3>JSON输出</h3>
                <pre id="json_output"></pre>
            </div>
        </div>
        <br>
    </div>

    <!-- 各种功能辅助 -->
    <div id='escape_helper' style="display:none"></div><!--  -->
    <input type="file" id='upload_helper' style="display:none">
    <a id='save_helper' style="display:none"></a>

    <!-- 全局DOM -->
    <script>
        upload_helper = document.getElementById('upload_helper')
        save_helper = document.getElementById('save_helper')
        module_pool = document.getElementById('module_pool')
        json_output = document.getElementById('json_output')
        module_pool.forEach = function (fun) {
            data = module_pool.children
            for (var i = 0; i < data.length; i++) {
                fun(data[i], i, data)
            }
            console.log('foreach end')
        }
    </script>

    <!-- 代码模块 -->
    <script>
        // codemirror
        function newTab(cm) {
            if (cm.somethingSelected()) {
                cm.indentSelection('add');
            } else {
                var tab_value = cm.getOption("indentWithTabs") ? "\t" : Array(cm.getOption("indentUnit") + 1).join(" ")
                cm.replaceSelection(tab_value, "end", "+input")
            }
        }

        function add_struct(obj = null) {
            if (typeof obj.show == 'undefined') obj = null
            var pool = document.createElement('div')
            pool.className = 'col-xs-12 module'

            // 属性
            {
                pool.type = 'struct'
                pool.show = obj ? obj.show : true
                pool.edit_display = false
                pool.text_cache = obj ? obj.display : ''
            }

            // 工具栏
            var toolbar = document.createElement('div')
            toolbar.className = 'toolbar'
            {// 设置可见性
                var btn_show = document.createElement('button')
                btn_show.className = 'btn-xs btn-info'
                toolbar.append(btn_show)
                btn_show.update = function () {
                    btn_show.innerHTML = '可见性: ' + (pool.show ? '可见' : '隐藏')
                }
                btn_show.addEventListener('click', function () {
                    pool.show = !pool.show
                    if (pool.show && pool.edit_display) toolbar.btn_mode.click()
                    btn_show.update()
                })
                btn_show.update()
                toolbar.btn_show = btn_show
            }
            {// 设置不可见时显示内容
                var btn_mode = document.createElement('button')
                btn_mode.className = 'btn-xs btn-info'
                toolbar.append(btn_mode)
                btn_mode.update = function () {
                    btn_mode.innerHTML = '编辑: ' + (pool.edit_display ? '显示内容' : '代码')
                }
                btn_mode.addEventListener('click', function () {
                    if (pool.show && (!pool.edit_display)) return;
                    pool.edit_display = !pool.edit_display
                    var tmp = pool.text_cache
                    pool.text_cache = pool.mirror.getValue()
                    pool.mirror.setValue(tmp)
                    btn_mode.update()
                })
                btn_mode.update()
                toolbar.btn_mode = btn_mode
            }
            pool.appendChild(toolbar)
            // codemirror
            var text = document.createElement('textarea')
            pool.appendChild(text)
            pool.mirror = CodeMirror.fromTextArea(text, {
                mode: "python",
                indentUnit: 4,
                indentWithTabs: true,
                lineWrapping: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                keyMap: 'sublime',
                extraKeys: { Tab: newTab },
            });
            if (obj && obj.code) pool.mirror.setValue(obj.code)

            module_pool.appendChild(pool)
        }
        document.getElementById('add_struct').addEventListener('click', add_struct)
    </script>

    <!-- 前端按钮 -->
    <script>
        // 读取保存JSON
        {
            document.getElementById('load_code').addEventListener('click', e => {
                upload_helper.click()
            })
            upload_helper.addEventListener('change', () => {
                if (!upload_helper.value) return
                var file_reader = new FileReader()
                file_reader.addEventListener('load', () => {
                    json_output.innerText = file_reader.result
                })
                file_reader.readAsText(upload_helper.files[0])
            })
            document.getElementById('save_code').addEventListener('click', e => {
                save_helper.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(json_output.innerText)
                save_helper.download = 'problem.json'
                save_helper.click()
            })
        }

        // 模块与json转换
        {
            document.getElementById('module_to_json').addEventListener('click', function () {
                var res = []
                module_pool.forEach(function (mod) {
                    if (typeof mod.mirror == 'undefined') return
                    var mod_dct = {}
                    mod_dct.type = mod.type
                    if (mod.type == 'struct') {// 给定代码
                        mod_dct.show = mod.show
                        var text = mod.mirror.getValue(), text_cache = mod.text_cache
                        if (mod.edit_display) {
                            text_cache = text
                            text = mod.text_cache
                        }
                        mod_dct.code = text
                        if (!mod.show) {
                            mod_dct.display = text_cache
                        }
                    } else {// 代码填空

                    }
                    res.push(mod_dct)
                })
                json_output.innerText = JSON.stringify(res)
            })
            document.getElementById('json_to_module').addEventListener('click', function () {
                module_pool.innerHTML = ''
                var pool = JSON.parse(json_output.innerText)
                pool.forEach(function (mod) {
                    if (mod.type == 'struct') {
                        add_struct(mod)
                    } else {

                    }
                })
            })
        }

        // setting buttons
        // {
        //     document.getElementById('codemirror_linewrap').addEventListener('click', e => {
        //         var self = e.path[0]
        //         e.stopPropagation();
        //         editor.setOption('lineWrapping', !editor.getOption('lineWrapping'))
        //         self.innerHTML = '自动换行: '
        //         if (editor.getOption('lineWrapping')) self.innerHTML += '开'
        //         else self.innerHTML += '关'
        //     })
        // }
    </script>
</body>

</html>